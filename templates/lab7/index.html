{% extends "base.html" %}

{% block lab %}Лабораторная работа 7{% endblock %}

{% block script %}
<script src="{{ url_for('static', filename='lab7/main.js') }}"></script>
<style>
    /* Общие стили */
    .film-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .film-table th {
        background-color: #4CAF50;
        color: white;
        padding: 12px;
        text-align: left;
        border: 1px solid #ddd;
        font-weight: bold;
    }
    
    .film-table td {
        padding: 12px;
        border: 1px solid #ddd;
        vertical-align: top;
    }
    
    .film-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .film-table tr:hover {
        background-color: #f5f5f5;
        transition: background-color 0.3s;
    }
    
    /* Стили для кнопок */
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        font-family: inherit;
    }
    
    .btn-primary {
        background-color: #4CAF50;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #45a049;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .btn-edit {
        background-color: #FF9800;
        color: white;
        margin-right: 8px;
    }
    
    .btn-edit:hover {
        background-color: #e68900;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .btn-delete {
        background-color: #f44336;
        color: white;
    }
    
    .btn-delete:hover {
        background-color: #d32f2f;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .btn-add {
        background-color: #9C27B0;
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: bold;
    }
    
    .btn-add:hover {
        background-color: #7b1fa2;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-secondary {
        background-color: #607d8b;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #546e7a;
    }
    
    /* Стили для форм */
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        font-family: inherit;
        font-size: 14px;
    }
    
    .form-control:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
    }
    
    /* Стили для ошибок */
    .error-message {
        color: #f44336;
        font-size: 12px;
        margin-top: 5px;
        font-style: italic;
    }
    
    .error-field {
        border-color: #f44336 !important;
        background-color: #ffebee;
    }
    
    /* Стили для оригинального названия (Задание 3) */
    .original-title {
        font-style: italic;
        color: #666;
        font-size: 0.9em;
    }
    
    .russian-title {
        font-weight: bold;
        color: #333;
    }
    
    /* Карточки для секций */
    .card {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }
    
    .card h4 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    /* Стили для вывода результатов */
    .output-panel {
        background: #f9f9f9;
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 5px;
        min-height: 300px;
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        overflow: auto;
        max-height: 500px;
        font-size: 14px;
    }
    
    /* Успешные сообщения */
    .success-message {
        color: #4CAF50;
        font-weight: bold;
        padding: 10px;
        background-color: #e8f5e9;
        border-radius: 4px;
        border-left: 4px solid #4CAF50;
    }
    
    .info-message {
        color: #2196F3;
        padding: 10px;
        background-color: #e3f2fd;
        border-radius: 4px;
        border-left: 4px solid #2196F3;
    }
    
    /* Контейнеры */
    .container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .sidebar {
        flex: 1;
        border-right: 1px solid #e0e0e0;
        padding-right: 20px;
    }
    
    .content {
        flex: 2;
    }
    
    /* Заголовки */
    h1 {
        color: #333;
        border-bottom: 3px solid #4CAF50;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    h2 {
        color: #555;
        margin-bottom: 30px;
    }
    
    h3 {
        color: #444;
        margin-top: 0;
    }
    
    /* Статистика */
    .stats {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
    }
    
    .stats p {
        margin: 5px 0;
    }
    
    .stat-value {
        font-weight: bold;
        color: #4CAF50;
        font-size: 1.1em;
    }
    
    /* Адаптивность */
    @media (max-width: 768px) {
        .container {
            flex-direction: column;
        }
        
        .sidebar {
            border-right: none;
            border-bottom: 1px solid #e0e0e0;
            padding-right: 0;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        
        .film-table {
            font-size: 14px;
        }
        
        .film-table th,
        .film-table td {
            padding: 8px;
        }
        
        .btn {
            padding: 6px 12px;
            font-size: 13px;
        }
    }
    
    /* API информация */
    .api-info {
        background: #e3f2fd;
        border-left: 4px solid #2196F3;
    }
    
    .api-info ul {
        margin: 10px 0;
        padding-left: 20px;
    }
    
    .api-info li {
        margin-bottom: 5px;
        line-height: 1.4;
    }
    
    /* Примечания */
    .note {
        font-size: 12px;
        color: #666;
        font-style: italic;
        margin-top: 5px;
    }
    
    /* Иконки */
    .icon {
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block main %}
    <h1>Лабораторная работа 7</h1>
    <h2>API REST - Управление фильмами</h2>
    
    <div style="margin-bottom: 30px;">
        <h3>Список фильмов</h3>
        <table class="film-table">
            <thead>
                <tr>
                    <!-- Задание 3: Оригинальное название первым -->
                    <th>Оригинальное название</th>
                    <th>Название (рус)</th>
                    <th>Год</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="film-list">
                <!-- Фильмы будут загружены через JavaScript -->
                <tr>
                    <td colspan="4" style="padding: 20px; text-align: center; color: #666;">
                        Загрузка фильмов...
                    </td>
                </tr>
            </tbody>
        </table>
        
        <script>
            // Автоматически загружаем фильмы при загрузке страницы
            document.addEventListener('DOMContentLoaded', function() {
                fillFilmList();
            });
        </script>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <button onclick="addFilm()" class="btn btn-add">
                <span class="icon">+</span> Добавить фильм
            </button>
        </div>
    </div>
    
    <div class="container">
        <!-- Левая колонка - тестирование API -->
        <div class="sidebar">
            <h3>Тестирование API</h3>
            
            <div class="card">
                <h4>1. Получить все фильмы (JSON)</h4>
                <button onclick="fetch('/lab7/rest-api/films/').then(r => r.json()).then(data => {
                    document.getElementById('output').innerHTML = '<h3>Все фильмы:</h3><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                })" class="btn btn-primary">
                    Получить JSON
                </button>
            </div>
            
            <div class="card">
                <h4>2. Редактировать фильм</h4>
                <div class="form-group">
                    <label class="form-label">ID фильма:</label>
                    <input type="number" id="editId" value="0" min="0" class="form-control" style="width: 80px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Название (англ):</label>
                    <input type="text" id="editTitle" class="form-control" placeholder="Введите оригинальное название">
                    <div class="note">Если оставить пустым, будет использовано русское название</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Название (рус): <span style="color: #f44336;">*</span></label>
                    <input type="text" id="editTitleRu" class="form-control" placeholder="Введите русское название" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Год: <span style="color: #f44336;">*</span></label>
                    <input type="number" id="editYear" min="1895" max="2025" class="form-control" placeholder="Год выпуска" style="width: 120px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Описание: <span style="color: #f44336;">*</span></label>
                    <textarea id="editDescription" rows="3" class="form-control" placeholder="Введите описание фильма"></textarea>
                </div>
                <button onclick="editFilmSubmit()" class="btn btn-edit">
                    <span class="icon">✏️</span> Обновить фильм
                </button>
                <p class="note">
                    <span style="color: #f44336;">*</span> - обязательные поля
                </p>
            </div>
            
            <div class="card">
                <h4>3. Статистика</h4>
                <div class="stats">
                    <p>Всего фильмов в базе: <span class="stat-value" id="films-count">{{ films_count }}</span></p>
                    <p>Доступные ID: от <span class="stat-value">0</span> до <span class="stat-value" id="max-id">{{ films_count-1 }}</span></p>
                </div>
            </div>
        </div>
        
        <!-- Правая колонка - вывод результатов -->
        <div class="content">
            <h3>Результаты запросов:</h3>
            <div id="output" class="output-panel">
                Нажмите кнопку для выполнения запроса...
            </div>
        </div>
    </div>
    
    <div class="card api-info">
        <h3>Информация о API:</h3>
        <ul>
            <li><strong>GET /lab7/rest-api/films/</strong> - получить все фильмы</li>
            <li><strong>GET /lab7/rest-api/films/&lt;id&gt;</strong> - получить фильм по ID</li>
            <li><strong>DELETE /lab7/rest-api/films/&lt;id&gt;</strong> - удалить фильм по ID</li>
            <li><strong>PUT /lab7/rest-api/films/&lt;id&gt;</strong> - обновить фильм</li>
            <li><strong>POST /lab7/rest-api/films/</strong> - добавить новый фильм</li>
        </ul>
        <div class="note">
            <strong>Валидация:</strong> Русское название, год и описание - обязательные поля. Год должен быть в диапазоне 1895-2025.
            Если оригинальное название не указано, автоматически используется русское название.
        </div>
    </div>
    
    <script>
    // Функция для очистки ошибок при начале редактирования
    function clearEditFormErrors() {
        const fields = ['editTitle', 'editTitleRu', 'editYear', 'editDescription'];
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.remove('error-field');
                const errorMsg = field.parentNode.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }
            }
        });
    }
    
    // Добавляем обработчики для очистки ошибок при фокусе
    document.addEventListener('DOMContentLoaded', function() {
        // Для формы редактирования
        const editFields = ['editTitle', 'editTitleRu', 'editYear', 'editDescription'];
        editFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('focus', function() {
                    this.classList.remove('error-field');
                    const errorMsg = this.parentNode.querySelector('.error-message');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                });
            }
        });
        
        // Для формы добавления (будет создана динамически)
        document.addEventListener('focusin', function(event) {
            if (event.target.id && (event.target.id.startsWith('new') || event.target.id.startsWith('edit'))) {
                event.target.classList.remove('error-field');
                const errorMsg = event.target.parentNode.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }
            }
        });
        
        // При нажатии на кнопку редактирования в таблице, очищаем ошибки
        document.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('btn-edit')) {
                setTimeout(clearEditFormErrors, 100);
            }
        });
    });
    </script>
{% endblock %}