<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab7 —Å –ë–î</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                 color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .task-complete { background: #e8f5e9; padding: 20px; border-radius: 8px; 
                        border-left: 5px solid #4CAF50; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #4CAF50; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border: 1px solid #ddd; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; 
               font-weight: bold; margin: 5px; }
        .btn-add { background: #9C27B0; color: white; }
        .btn-edit { background: #FF9800; color: white; }
        .btn-delete { background: #f44336; color: white; }
        .form-group { margin: 15px 0; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; }
        .error { color: #f44336; font-size: 14px; }
    </style>
</head>
<body>
    <div style="position: fixed; top: 20px; left: 20px; z-index: 1000;">
    <a href="/" style="display: inline-block; padding: 10px 20px; background: #4CAF50; 
       color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
        ‚Üê –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é
    </a>
</div>
    <div class="header">
        <h1>üé¨ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 7</h1>
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞–º–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</h2>
    </div>
    
    <div class="task-complete">
        <h3>‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:</h3>
        <p><strong>1. –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:</strong> –†—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –≥–æ–¥ 1895-—Ç–µ–∫—É—â–∏–π, –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ 2000 —Å–∏–º–≤–æ–ª–æ–≤</p>
        <p><strong>2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> SQLite, —Ç–∞–±–ª–∏—Ü–∞ movies_final, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</p>
        <p><strong>–§–∏–ª—å–º–æ–≤ –≤ –±–∞–∑–µ:</strong> <span id="films-count">{{ films_count }}</span></p>
    </div>
    
    <div>
        <button class="btn btn-add" onclick="showAddForm()">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º</button>
        <button class="btn" onclick="loadFilms()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>
    
    <h3>–°–ø–∏—Å–æ–∫ —Ñ–∏–ª—å–º–æ–≤:</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–†—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ì–æ–¥</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="films-table"></tbody>
    </table>
    
    <div id="form-container" style="display: none; margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
        <h3 id="form-title">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞</h3>
        <div class="form-group">
            <label>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" id="film-title" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
        </div>
        <div class="form-group">
            <label>–†—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ *:</label>
            <input type="text" id="film-title-ru" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
        </div>
        <div class="form-group">
            <label>–ì–æ–¥ *:</label>
            <input type="number" id="film-year" min="1895" max="2025" value="2024">
        </div>
        <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ *:</label>
            <textarea id="film-description" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–º–∞–∫—Å. 2000 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
        </div>
        <input type="hidden" id="film-id" value="">
        <button class="btn btn-add" onclick="saveFilm()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="hideForm()">‚ùå –û—Ç–º–µ–Ω–∞</button>
        <div id="error-message" class="error"></div>
    </div>
    
    <script>
    let editingId = null;
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å–º–æ–≤
    function loadFilms() {
        fetch('/api/films')
            .then(r => r.json())
            .then(films => {
                const tbody = document.getElementById('films-table');
                tbody.innerHTML = '';
                
                films.forEach(film => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${film.id}</td>
                        <td>${film.title === film.title_ru ? '' : film.title}</td>
                        <td>${film.title_ru}</td>
                        <td>${film.year}</td>
                        <td>
                            <button class="btn btn-edit" onclick="editFilm(${film.id})">‚úèÔ∏è –†–µ–¥.</button>
                            <button class="btn btn-delete" onclick="deleteFilm(${film.id}, '${film.title_ru}')">üóëÔ∏è –£–¥.</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                document.getElementById('films-count').textContent = films.length;
            });
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function showAddForm() {
        editingId = null;
        document.getElementById('form-title').textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞';
        document.getElementById('film-id').value = '';
        document.getElementById('film-title').value = '';
        document.getElementById('film-title-ru').value = '';
        document.getElementById('film-year').value = new Date().getFullYear();
        document.getElementById('film-description').value = '';
        document.getElementById('form-container').style.display = 'block';
        document.getElementById('error-message').textContent = '';
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å–º
    function editFilm(id) {
        fetch(`/api/films/${id}`)
            .then(r => r.json())
            .then(film => {
                editingId = id;
                document.getElementById('form-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞';
                document.getElementById('film-id').value = id;
                document.getElementById('film-title').value = film.title;
                document.getElementById('film-title-ru').value = film.title_ru;
                document.getElementById('film-year').value = film.year;
                document.getElementById('film-description').value = film.description;
                document.getElementById('form-container').style.display = 'block';
                document.getElementById('error-message').textContent = '';
            });
    }
    
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–ª—å–º
    function saveFilm() {
        const filmData = {
            title: document.getElementById('film-title').value.trim(),
            title_ru: document.getElementById('film-title-ru').value.trim(),
            year: parseInt(document.getElementById('film-year').value),
            description: document.getElementById('film-description').value.trim()
        };
        
        const url = editingId ? `/api/films/${editingId}` : '/api/films';
        const method = editingId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(filmData)
        })
        .then(r => {
            if (r.ok) {
                return r.json();
            } else {
                return r.json().then(err => { throw err; });
            }
        })
        .then(result => {
            alert(editingId ? '–§–∏–ª—å–º –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–§–∏–ª—å–º –¥–æ–±–∞–≤–ª–µ–Ω!');
            hideForm();
            loadFilms();
        })
        .catch(error => {
            if (error.errors) {
                let errorMsg = '–û—à–∏–±–∫–∏:\n';
                error.errors.forEach(err => {
                    errorMsg += `‚Ä¢ ${err.field}: ${err.message}\n`;
                });
                document.getElementById('error-message').textContent = errorMsg;
            } else {
                document.getElementById('error-message').textContent = '–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        });
    }
    
    // –£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º
    function deleteFilm(id, title) {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º "${title}"?`)) {
            fetch(`/api/films/${id}`, {method: 'DELETE'})
                .then(r => {
                    if (r.ok) {
                        alert('–§–∏–ª—å–º —É–¥–∞–ª–µ–Ω!');
                        loadFilms();
                    }
                });
        }
    }
    
    // –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É
    function hideForm() {
        document.getElementById('form-container').style.display = 'none';
    }
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–ª—å–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', loadFilms);
    </script>
</body>
</html>
